Data import using a program
===============================

This article will introduce how to import data into PolarDB-X by writing code.

Suppose there is an action table:

```sql
CREATE TABLE `test1` (
`id` int(11) NOT NULL,
`k` int(11) NOT NULL DEFAULT '0',
`c` char(120) NOT NULL DEFAULT '',
`pad` char(60) NOT NULL DEFAULT '',
PRIMARY KEY (`id`),
KEY `k_1` (`k`)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 dbpartition by hash(`id`);
```



Export source data from database
-------------------------------

The source data can be generated by the user or exported from the database. The `mysql -e` command can be used to export the data in the database. Both PolarDB-X and MySQL support this method. The specific method is as follows:

```shell
mysql -h ip  -P port -u usr -pPassword db_name -N -e "SELECT id,k,c,pad FROM test1;" >/home/data_1000w.txt
## Raw data is separated by tabs, data format: 188092293 27267211 59775766593-64673028018-...-09474402685 01705051424-...-54211554755
mysql -h ip  -P port -u usr -pPassword db_name -N -e "SELECT id,k,c,pad FROM test1;" | sed 's/\t/,/g' >/home/data_1000w.csv
## csv file format separated by commas, data format: 188092293,27267211,59775766593-64673028018-...-09474402685,01705051424-...-54211554755
```



It is recommended to process the string and convert it into a csv file format, which is convenient for subsequent programs to read the data.

Create target table in PolarDB-X
----------------------------------

The source data does not include table creation statements, so tables need to be manually created on the PolarDB-X target database. For the syntax of PolarDB-X table creation statements, please refer to [CREATE TABLE](../../dev-guide/topics/create -table.md) statement, for example:

```sql
CREATE TABLE `test1` (
`id` int(11) NOT NULL,
`k` int(11) NOT NULL DEFAULT '0',
`c` char(120) NOT NULL DEFAULT '',
`pad` char(60) NOT NULL DEFAULT '',
PRIMARY KEY (`id`),
KEY `k_1` (`k`)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 dbpartition by hash(`id`);
```



Use the program to import data to PolarDB-X
------------------------------------

You can write your own program, connect to PolarDB-X, then read local data, and import it into PolarDB-X through Batch Insert statement.

The following is a simple JAVA program example:

```java
// Requires mysql-connector-java.jar, detailed interface: https://mvnrepository.com/artifact/mysql/mysql-connector-java
// Download link: https://repo1.maven.org/maven2/mysql/mysql-connector-java/8.0.20/mysql-connector-java-8.0.20.jar
// Note: Different versions of mysql-connector-java.jar may have different Class.forName("com.mysql.cj.jdbc.Driver") class paths
// compile javac LoadData.java
// Run java -cp .:mysql-connector-java-8.0.20.jar LoadData
import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.SQLException;
public class LoadData {
public static void main(String[] args) throws IOException, ClassNotFoundException, SQLException {
File dataFile = new File("/home/data_1000w.csv");
String sql = "insert into test1(id, k, c, pad) values(?, ?, ?, ?)";
int batchSize = 1000;
try (
Connection connection = getConnection("ip", 3306, "db", "usr", "password");
BufferedReader br = new BufferedReader(new FileReader(dataFile))) {
String line;
PreparedStatement st = connection.prepareStatement(sql);
long startTime = System.currentTimeMillis();
int batchCount = 0;
while ((line = br.readLine()) != null) {
String[] data = line.split(",");
st.setInt(1, Integer.valueOf(data[0]));
st.setInt(2, Integer.valueOf(data[1]));
st.setObject(3, data[2]);
st.setObject(4, data[3]);
st.addBatch();
if (++batchCount % batchSize == 0) {
st.executeBatch();
System.out.println(String.format("insert %d records", batchCount));
}
}
if (batchCount % batchSize != 0) {
st.executeBatch();
}
long cost = System.currentTimeMillis() - startTime;
System.out.println(String.format("Take %d secondï¼Œinsert %d records, tps %d", cost/1000, batchCount, batchCount/(cost/1000)));
}
}
/**
* Get database connection
*
* @param host database address
* @param port port
* @param database database name
* @param username username
* @param password password
* @return
* @throws ClassNotFoundException
* @throws SQLException
*/
private static Connection getConnection(String host, int port, String database, String username, String password)
throws ClassNotFoundException, SQLException {
Class.forName("com.mysql.cj.jdbc.Driver");
String url = String.format(
"jdbc:mysql://%s:%d/%s?autoReconnect=true&socketTimeout=600000&rewriteBatchedStatements=true", host, port,
database);
Connection con = DriverManager.getConnection(url, username, password);
return con;
}
}
```



You can write programs according to actual application scenarios, set appropriate batch size and multi-thread import, which can speed up performance.
