加密和压缩函数 
============================

本文主要介绍PolarDB-X支持的加密和压缩函数。

支持的加密和压缩函数 
-------------------------------

PolarDB-X目前支持mysql 5.7的大部分未过时的加密和压缩函数，具体信息见下表：


| 函数名       | 描述                  |
| :----------- | :-------------------- |
| AES_DECRYPT  | 使用AES算法解密       |
| AES_ENCRYPT  | 使用AES算法加密       |
| RANDOM_BYTES | 返回随机字节向量      |
| MD5          | 计算MD5 128位校验和   |
| SHA1, SHA    | 计算SHA-1 160位校验和 |
| SHA2         | 计算SHA2校验和        |



对于加密和压缩函数，如果需要存储字节类型的返回结果，推荐使用VARBINARY或BLOB字段，避免尾部空白字符的移除或字符集转换问题（如CHAR/VARCHAR/TEXT类型）。

AES_DECRYPT(crypt_str, key_str \[, init_vector\]) 
----------------------------------------------------------------------

根据输入的密文crypt_str、密钥key_str以及初始向量init_vector（可选参数），返回解密后的明文结果。具体解密算法与使用方法可参考AES_ENCRYPT函数。

AES_ENCRYPT(str, key_str \[, init_vector\]) 
----------------------------------------------------------------

根据输入的明文str、密钥key_str以及初始向量init_vector（可选参数），返回加密后的密文结果。在加密时具体使用的AES算法由系统变量[block_encryption_mode](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_block_encryption_mode) 决定，该变量取值的格式为`aes-keylen-mode`，其中keylen为密钥的位长度（合法取值为128/192/256），mode为加密模式，PolarDB-X支持以下六种加密模式：


|  加密模式  | 是否需要初始向量 |
|--------|----------|
| ECB    | 否        |
| CBC    | 是        |
| CFB1   | 是        |
| CFB8   | 是        |
| CFB128 | 是        |
| OFB    | 是        |



对于需要初始向量的加密模式，初始向量必须大于等于16字节（超出16字节部分将自动截断）；对于不需要初始向量的加密模式，初始向量参数将被自动忽略。

示例：

```unknow
mysql> SET block_encryption_mode = 'aes-128-ofb';
mysql> SET @iv = RANDOM_BYTES(16);
mysql> SET @key = SHA2('secret key', 224);
mysql> set @crypto = AES_ENCRYPT('polardb-x', @key, @iv);
mysql> select @crypto;
+---------------------------+
| @crypto                   |
+---------------------------+
|  ß÷s,(ÿýÂåîA}ýO          |
+---------------------------+
mysql> SELECT AES_DECRYPT(@crypto, @key, @iv);
+---------------------------------+
| AES_DECRYPT(@crypto, @key, @iv) |
+---------------------------------+
| polardb-x                       |
+---------------------------------+
```



RANDOM_BYTES(len) 
--------------------------------------

返回len字节长度的随机二进制字符串，长度len的合法取值为1\~1024。

示例：

```unknow
mysql> select HEX(RANDOM_BYTES(16));
+----------------------------------+
| HEX(RANDOM_BYTES(16))            |
+----------------------------------+
| C83CF8A2499F407E15F34F6E32948CEA |
+----------------------------------+
```



MD5(str) 
-----------------------------

计算MD5 128位检验和。

示例：

```unknow
mysql> select MD5('polardb-x');
+----------------------------------+
| MD5('polardb-x')                 |
+----------------------------------+
| fa4900656bcd39dc90024e733fa4531f |
+----------------------------------+
```



SHA1(str), SHA(str) 
----------------------------------------

计算SHA-1 160位校验和。该函数安全性强于MD5。

示例：

```unknow
mysql> select SHA1('polardb-x');
+------------------------------------------+
| SHA1('polardb-x')                        |
+------------------------------------------+
| a2e83af051f032b500f13c369976298208d821d1 |
+------------------------------------------+
```



SHA2(str, hash_length) 
-------------------------------------------

计算SHA-2族散列算法结果，参数hash_length决定了检验和结果的位数，合法取值包括：224、256、384、512和0（等价于256）。该函数安全性强于MD5和SHA1。

示例：

```unknow
mysql> select SHA2('polardb-x', 384);
+--------------------------------------------------------------------------------------------------+
| SHA2('polardb-x', 384)                                                                           |
+--------------------------------------------------------------------------------------------------+
| 20222037666be5234d9af3c391f9c3a1a3e39b910f3f8081c32d972acca890c818d6c70025ff6c6d4b648bd91d66a3fe |
+--------------------------------------------------------------------------------------------------+
```

